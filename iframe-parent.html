<!DOCTYPE html>
<html lang="en-US">

  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta http-equiv='cache-control' content='no-cache'>
    <meta http-equiv='expires' content='0'>
    <meta http-equiv='pragma' content='no-cache'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description"
      content="Playground to explore web analytics implementation on a web app using various analytics tools." />
    <link rel='canonical' href='https://arsari.github.io/AnalyticsWeb' />
    <link rel="shortcut icon" type="image/x-icon" sizes="16x16" href="favicon.ico" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/style.css" />
    <title>AnalyticsWeb | Parent iFrame Page</title>
    <!--New Relic Snippet-->
    <script type="text/javascript" src="assets/newRelic.js"></script>
    <!--END: New Relic Snippet-->
    <!--Mixpanel Script Loader-->
    <script type="text/javascript">
      (function (f, b) { if (!b.__SV) { var e, g, i, h; window.mixpanel = b; b._i = []; b.init = function (e, f, c) { function g(a, d) { var b = d.split("."); 2 == b.length && ((a = a[b[0]]), (d = b[1])); a[d] = function () { a.push([d].concat(Array.prototype.slice.call(arguments, 0))); }; } var a = b; "undefined" !== typeof c ? (a = b[c] = []) : (c = "mixpanel"); a.people = a.people || []; a.toString = function (a) { var d = "mixpanel"; "mixpanel" !== c && (d += "." + c); a || (d += " (stub)"); return d; }; a.people.toString = function () { return a.toString(1) + ".people (stub)"; }; i = "disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking start_batch_senders people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" "); for (h = 0; h < i.length; h++) g(a, i[h]); var j = "set set_once union unset remove delete".split(" "); a.get_group = function () { function b(c) { d[c] = function () { call2_args = arguments; call2 = [c].concat(Array.prototype.slice.call(call2_args, 0)); a.push([e, call2]); }; } for (var d = {}, e = ["get_group"].concat(Array.prototype.slice.call(arguments, 0)), c = 0; c < j.length; c++) b(j[c]); return d; }; b._i.push([e, f, c]); }; b.__SV = 1.2; e = f.createElement("script"); e.type = "text/javascript"; e.async = !0; e.src = "undefined" !== typeof MIXPANEL_CUSTOM_LIB_URL ? MIXPANEL_CUSTOM_LIB_URL : "file:" === f.location.protocol && "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//) ? "https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js" : "//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js"; g = f.getElementsByTagName("script")[0]; g.parentNode.insertBefore(e, g); } })(document, window.mixpanel || []);
    </script>
    <!--End Mixpanel Script Loader-->
    <!--dataLayers message-->
    <script type="text/javascript">
      const userInit = localStorage.UUID ?? 'guest';
      window.dataLayer = window.dataLayer || [];
      window.dataLayer.push({
        author_email: 'asantiago@arsari.com',
        content_group: 'Implementation',
        content_type: 'Playground',
        e_timestamp: String(new Date().getTime()), // milliseconds
        language_code: 'en-US',
        page_author: 'Arturo Santiago-Rivera',
        page_category: 'iframe',
        page_name: 'Web Analytics Implementation - Internal Page',
        page_title: document.querySelector('title').innerText,
        // user properties
        logged_in: localStorage.logged ?? false,
        user_id: userInit,
      });
    </script>
    <!--END: dataLayers message-->
    <!--Google Tag Manager-->
    <script>
      (function (w, d, s, l, i) {
        w[l] = w[l] || [];
        w[l].push({
          'gtm.start': new Date().getTime(),
          event: 'gtm.js',
        });
        const f = d.getElementsByTagName(s)[0];
        const j = d.createElement(s);
        const dl = l !== 'dataLayer' ? `&l=${l}` : '';
        j.async = true;
        j.src = `https://www.googletagmanager.com/gtm.js?id=${i}${dl}`;
        f.parentNode.insertBefore(j, f);
      })(window, document, 'script', 'dataLayer', 'GTM-59FGRVM');
    </script>
    <!--End Google Tag Manager-->
    <!--Amplitude Script Loader-->
    <script src="https://cdn.amplitude.com/libs/analytics-browser-2.11.3-min.js.gz"></script>
    <!--End Amplitude Script Loader-->
    <!--Tracking Variables Setup-->
    <script type="text/javascript">
      /* Tealium iQ */
      const tealiumEnv =
        location.search.indexOf('dev') === 1 || document.location.host.includes('127.0.0.1')
          ? 'dev'
          : location.search.indexOf('qa') === 1
            ? 'qa'
            : 'prod';
      const ga4Prop = tealiumEnv !== 'prod' ? 'G-0Q482J3LCH' : 'G-K9GKNM79XW';
      const heapAppId = tealiumEnv !== 'prod' ? '2029282835' : '1106616054';
      const gtmContainer = 'GTM-59FGRVM';

      /* Adobe Data Collection (Launch) */
      let alaunch;
      let alaunchEnv;
      if (tealiumEnv !== 'prod') {
        alaunch = 'https://assets.adobedtm.com/a5bd983fc228/a715fbe791c6/launch-fbe47ad2001a-development.min.js';
        alaunchEnv = 'development';
      } else {
        alaunch = 'https://assets.adobedtm.com/a5bd983fc228/a715fbe791c6/launch-cfa4016bf67d.min.js';
        alaunchEnv = 'production';
      }
      const script = document.createElement('script');
      script.type = 'text/javascript';
      script.src = alaunch;
      script.async = true;
      document.head.appendChild(script);

      /* Amplitude Analytics Init*/
      const enrichEventsPlugin = () => ({
        name: "enrichEventsPlugin",
        execute: async (event) => {
          event.event_properties = {
            ...event.event_properties,
            author_email: 'asantiago@arsari.com',
            content_group: 'Implementation',
            content_type: 'Playground',
            env_viewed: tealiumEnv,
            language_code: 'en-US',
            page_author: 'Arturo Santiago-Rivera',
            page_category: 'iframe',
            page_name: 'Web Analytics Implementation - Internal Page',
            page_title: document.querySelector('title').innerText,
          };
          return event;
        },
      });
      window.amplitude.add(enrichEventsPlugin()); // amplitude enrich plugin call
      window.amplitude.init('1dc51d64353a705b95a9bd848ebbe490', userInit, {
        autocapture: { elementInteractions: false }
      }); // amplitude init statement

      /* Mixpanel */
      mixpanel.init('9d684b4f1063f3d1e965ca6d15510376'); // mixpanel init statement
      mixpanel.identify(userInit); // mixpanel user identify
      mixpanel.people.set({
        logged_in: localStorage.logged ?? false,
        custom_user_id: userInit,
      });
      mixpanel.register({
        author_email: 'asantiago@arsari.com',
        content_group: 'Implementation',
        content_type: 'Playground',
        env_viewed: tealiumEnv,
        language_code: 'en-US',
        page_author: 'Arturo Santiago-Rivera',
        page_category: 'iframe',
        page_name: 'Web Analytics Implementation - Internal Page',
        page_title: document.querySelector('title').innerText,
      });
      mixpanel.track_pageview({
        e_timestamp: String(new Date().getTime()), // milliseconds
      });

      /* Console Table */
      const ids = {
        Env: tealiumEnv,
        GA4: ga4Prop,
        GTM: gtmContainer,
        Launch: alaunchEnv,
        Heap: heapAppId === '2029282835' ? `${heapAppId} (dev)` : `${heapAppId} (prod)`,
        userID: userInit,
      };
      console.table(ids);
    </script>
    <!--END Tracking Variables Setup-->
    <!--Microsoft Clarity-->
    <script type="text/javascript">
      (function (c, l, a, r, i, t, y) {
        c[a] =
          c[a] ||
          function () {
            (c[a].q = c[a].q || []).push(arguments);
          };
        t = l.createElement(r);
        t.async = 1;
        t.src = `https://www.clarity.ms/tag/${i}`;
        y = l.getElementsByTagName(r)[0];
        y.parentNode.insertBefore(t, y);
      })(window, document, 'clarity', 'script', 'kwkjo3v6wy');
    </script>
    <!-- End Microsoft Clarity -->
    <!-- Heap Analytics -->
    <script type="text/javascript">
      (window.heap = window.heap || []),
        (heap.load = function (e, t) {
          (window.heap.appid = e), (window.heap.config = t = t || {});
          const r = document.createElement('script');
          (r.type = 'text/javascript'), (r.async = !0), (r.src = `https://cdn.heapanalytics.com/js/heap-${e}.js`);
          const a = document.getElementsByTagName('script')[0];
          a.parentNode.insertBefore(r, a);
          for (
            let n = function (e) {
              return function () {
                heap.push([e].concat(Array.prototype.slice.call(arguments, 0)));
              };
            },
            p = [
              'addEventProperties',
              'addUserProperties',
              'clearEventProperties',
              'identify',
              'resetIdentity',
              'removeEventProperty',
              'setEventProperties',
              'track',
              'unsetEventProperty',
            ],
            o = 0;
            o < p.length;
            o++
          )
            heap[p[o]] = n(p[o]);
        });
      heap.load(heapAppId);
      heap.identify(userInit);
      heap.addUserProperties({ logged_in: localStorage.logged ?? false });
    </script>
    <!-- END Heap Analytics -->
  </head>

  <body>
    <!-- utag data object message -->
    <script type="text/javascript">
      const utag_data = {
        author_email: 'asantiago@arsari.com',
        content_group: 'Implementation',
        content_type: 'Playground',
        e_timestamp: String(new Date().getTime()), // milliseconds
        language_code: 'en-US',
        page_author: 'Arturo Santiago-Rivera',
        page_category: 'iframe',
        page_name: 'Web Analytics Implementation - Internal Page',
        page_title: document.querySelector('title').innerText,
        // user properties
        custom_user_id: userInit,
        logged_in: localStorage.logged ?? false,
        user_id: userInit,
      };
    </script>
    <!-- END: utag data object message -->
    <!-- Tealium IQ Loading script asynchronously -->
    <script type="text/javascript">
      (function (a, b, c, d) {
        a = `https://tags.tiqcdn.com/utag/blastam/arsari-training/${tealiumEnv}/utag.js`;
        b = document;
        c = 'script';
        d = b.createElement(c);
        d.src = a;
        d.type = `text/java${c}`;
        d.async = true;
        a = b.getElementsByTagName(c)[0];
        a.parentNode.insertBefore(d, a);
      })();
    </script>
    <!-- END: Tealium IQ Loading script asynchronously -->
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-59FGRVM" height="0" width="0"
        style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    <header>
      <div class="title">
        <h1>
          AnalyticsWeb | ARSARI
          <span class="github-badges">
            <img
              src="https://img.shields.io/github/last-commit/arsari/AnalyticsWeb?color=orange&style=flat-square&logo=github"
              alt="GitHub Last Commit" title="Source Code Last Update" />
            <img src="https://img.shields.io/github/v/tag/arsari/AnalyticsWeb?logo=github&sort=semver&style=flat-square"
              alt="GitHub tag (latest SemVer)" title="Source Code Current Version" />
          </span>
        </h1>
      </div>
      <div class="desc">
        <h2>
          <span>iFrame Parent Page</span>
        </h2>
      </div>
    </header>
    <main>
      <aside>
        <section id="iframe-section1" class="iframe-container">
          <iframe id="iframe-child1" src="iframe-child.html" title="iFrame Child Page"></iframe>
        </section>
        <h3 style="text-align: center;">iFrame postMessage Action Tracking</h3>
        <section id="iframe-section2" class="iframe-container">
          <iframe id="iframe-child2" src="https://arsari.github.io/Integer-to-Word/" title="iFrame Child Page"></iframe>
        </section>
        <h3 style="text-align: center;">iFrame Random Click Tracking</h3>
      </aside>
      <section id="json-section" class="pre"></section>
    </main>
    <footer></footer>
    <script type="text/javascript" src="assets/function.min.js"></script>
    <script type="text/javascript">
      /**
       * Populate section element with initial data layer object
       */
      document.querySelector(
        '#json-section',
      ).innerHTML += `<p><em>Message: dataLayer.push and utag_data</em></p><pre>${JSON.stringify(
        window.dataLayer.at(0),
        undefined,
        2,
      )}</pre>`;

      /**
       * Scroll to last child element of section tag and highlight (focus) it
       */
      document.querySelector('#json-section').lastElementChild.scrollIntoView();
      document.querySelector('#json-section').lastElementChild.className = 'highlight';

      function sendDataLayer(en, ed) {
        let eventName = en;
        let eventData = ed;
        let logged = localStorage.logged ?? false;
        let tstamp = String(new Date().getTime());
        let cstamp = timeStamp();

        /* Send data to GTM/GA4 */
        window.dataLayer = window.dataLayer || [];
        window.dataLayer.push({
          event: eventName,
          ...eventData,
          event_type: "ui interaction",
          e_timestamp: tstamp, // milliseconds
          custom_timestamp: cstamp, // ISO 8601
          // user properties
          logged_in: logged,
          user_id: userInit,
        });
        /* Send data to Tealium */
        utag.link({
          tealium_event: eventName,
          ...eventData,
          event_type: "ui interaction",
          e_timestamp: tstamp, // milliseconds
          custom_timestamp: cstamp, // ISO 8601
          // user properties
          logged_in: logged,
          user_id: userInit,
          custom_user_id: userInit,
        });
        /* Send data to Amplitude */
        amplitude.setUserId(userInit);
        amplitude.track({
          event_type: eventName,
          event_properties: {
            ...eventData,
            event_type: "ui interaction",
            e_timestamp: tstamp, // milliseconds
            custom_timestamp: cstamp, // ISO 8601
          },
          user_properties: {
            $set: {
              logged_in: logged,
              custom_user_id: userInit,
            },
          },
        });
        /* Send data to Mixpanel */
        mixpanel.identify(userInit);
        mixpanel.people.set({
          logged_in: logged,
          custom_user_id: userInit,
        });
        mixpanel.track(eventName, {
          ...eventData,
          event_type: "ui interaction",
          e_timestamp: tstamp, // milliseconds
          custom_timestamp: cstamp, // ISO 8601
        });

        displayJSON(logged, 'dataLayer.push');
      }

      /**
       * Function to handle incoming messages from iFrame
       */
      window.addEventListener('message', (event) => {
        try {
          if (event.data.event === 'iframeEvent') {
            let eventName = event.data.name;
            let eventData = event.data.data;
            sendDataLayer(eventName, eventData);
          }
        } catch (e) {
          console.error('Error receiving message from iFrame', e);
        }
      });

      /**
       * iFrame Interaction Monitoring
       */
      const monitoriFrame = setInterval(() => {
        const iframe = document.activeElement;
        if (iframe.id === "iframe-child2") {
          let eventName = "iframe_interaction";
          let eventData = {
            tag_name: iframe.tagName,
          };
          sendDataLayer(eventName, eventData);
        }
        iframe.blur();
      }, 500);

      /**
       * Clear interval when user leaves the page
       */
      window.addEventListener('beforeunload', () => {
        clearInterval(monitoriFrame);
      });
    </script>
  </body>

</html>